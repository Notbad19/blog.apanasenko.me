<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru">
	<head>
 	  	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	  	<title>
	    	 Scala Actors (part 2)  
	  	</title>
		<link rel="stylesheet" href="/css/style.css" type="text/css" media="all"/>
	</head>
<body>
<div id="header">
	<ul id="nav" class="nav"> 
		<li id="main" class="selected"><a href="/"><strong>Home</strong><span>main page</span></a></li> 
		<li id="post"><a href="/2009/12/scala-actors-part-2"><strong>Blog</strong> <span>post</span></a></li>
		<li id="archive"><a href="/archive"><strong>Archive</strong></a></li> 
		<li><a href="http://ru.linkedin.com/in/apanasenko/"><strong>LinkedIn</strong> <span>&rarr;</span></a></li> 
		<li><a href="http://github.com/dieu"><strong>Github</strong> <span>&rarr;</span></a></li> 
		<li><a href="http://twitter.com/apanasenko"><strong>Twitter</strong> <span>&rarr;</span></a></li> 
	</ul>
</div>
<div id="container">			
	<div class="bar"> 
	</div> 
	<br/>
	<div id="content">
			<!-- <span id="article_buttons">
  <a id="tweet">
    <span class="balloon">tweet!</span> <img src="/images/tweet.png"/ alt="tweet"/>
  </a>
  <a href="http://feeds.feedburner.com/apanasenko">
    <span class="balloon">subscribe!</span> <img src="/images/feed.png" alt="feed"/> 
  </a>
</span>

<hr/> -->

<div class="content">
	<center><img src="http://lh5.ggpht.com/_wN3Yn5K_LYs/SyUTH_nU5hI/AAAAAAAAAI0/buL0ZX6nd7M/scala_logo.png?imgmax=800" alt="scala_logo.png" width="268" height="174" /></center>
<p>В прошлой <a href="http://blog.apanasenko.me/2009/12/scala-fl-jvm-part-1/">статье</a> я попытался рассказать, о том что такое <strong>Scala</strong> и особенностях синтаксиса/языка по сравнению с <strong>Java</strong>. В этом посте попробую рассмотреть <strong>Scala Actors</strong>. С появлением многоядерных процессоров параллельное программирование становится незаменимым. Параллелизм в <strong>Scala</strong> строиться в первую очередь с помощью <strong>actors</strong>. <strong>Actors</strong> это параллельные процессы, которые взаимодействуют путем обмена сообщениями. <strong>Actors</strong> можно также рассматривать как одну из форм активных объектов, где применение метода соответствует посылке сообщений.</p>
<p>Библиотеки реализующие модель взаимодействия процессов <strong>Actors</strong> в <strong>Scala</strong> обеспечивают как асинхронный так и синхронный обмен сообщеними (последняя осуществляется путем обмена нескольких асинхронных сообщений). Кроме того, <strong>actors</strong> могут общаться с помощью <strong>futures</strong>, где запросы обрабатываются асинхронно, а ответ синхронно (в будущем), что позволяет ожидать его.</p>
<p><a href="http://lh3.ggpht.com/_wN3Yn5K_LYs/SyU60dL8s-I/AAAAAAAAAI8/hrxPRwC05lM/actors.png"><div style="text-align:center;"><br />
<img src="http://lh3.ggpht.com/_wN3Yn5K_LYs/SyU60dL8s-I/AAAAAAAAAI8/hrxPRwC05lM/actors.png?imgmax=800" alt="actors.png" border="0" width="600" height="500" /></div></a></p>
<p>Далее можно рассмотреть простой пример пинг понга:</p>
<div class="highlight"><pre><code class="scala"><span class="k">case</span> <span class="k">object</span> <span class="nc">Ping</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">Pong</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">Stop</span>

<span class="k">class</span> <span class="nc">Ping</span><span class="o">(</span><span class="n">count</span><span class="k">:</span> <span class="kt">int</span><span class="o">,</span> <span class="n">pong</span><span class="k">:</span> <span class="kt">Actor</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">act</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">var</span> <span class="n">pingsLeft</span> <span class="k">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">pong</span> <span class="o">!</span> <span class="nc">Ping</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">receive</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Pong</span> <span class="k">=&gt;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">pingsLeft</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
            <span class="nc">Console</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="s">&quot;Ping: pong&quot;</span><span class="o">)</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">pingsLeft</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">pong</span> <span class="o">!</span> <span class="nc">Ping</span>
            <span class="n">pingsLeft</span> <span class="o">-=</span> <span class="mi">1</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">Console</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="s">&quot;Ping: stop&quot;</span><span class="o">)</span>
            <span class="n">pong</span> <span class="o">!</span> <span class="nc">Stop</span>
            <span class="n">exit</span><span class="o">()</span>
          <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div><p><br/></p>
<div class="highlight"><pre><code class="scala"><span class="k">class</span> <span class="nc">Pong</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">act</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">var</span> <span class="n">pongCount</span> <span class="k">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">receive</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Ping</span> <span class="k">=&gt;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">pongCount</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
            <span class="nc">Console</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="s">&quot;Pong: ping &quot;</span><span class="o">+</span><span class="n">pongCount</span><span class="o">)</span>
          <span class="n">sender</span> <span class="o">!</span> <span class="nc">Pong</span>
          <span class="n">pongCount</span> <span class="k">=</span> <span class="n">pongCount</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">case</span> <span class="nc">Stop</span> <span class="k">=&gt;</span>
          <span class="nc">Console</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="s">&quot;Pong: stop&quot;</span><span class="o">)</span>
          <span class="n">exit</span><span class="o">()</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div><ul>
	<li>Нужно заметить, что использование <strong>trait Application</strong> не желательно в многопточных приложения. Более подробно о проблеме <a href="http://scala-blogs.org/2008/07/application-trait-considered-harmful.html">в блоге разработчиков</a>.</li>
</ul>
<div class="highlight"><pre><code class="scala"><span class="k">object</span> <span class="nc">Pingpong</span> <span class="k">extends</span> <span class="nc">Application</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">pong</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Pong</span>
    <span class="k">val</span> <span class="n">ping</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Ping</span><span class="o">(</span><span class="mi">100000</span><span class="o">,</span> <span class="n">pong</span><span class="o">)</span>
    <span class="n">ping</span><span class="o">.</span><span class="n">start</span>
    <span class="n">pong</span><span class="o">.</span><span class="n">start</span>
<span class="o">}</span>
</code></pre>
</div><p>Этот пример состоит из двух <strong>actor</strong>&#8216;ов, которые обмениваются несколькими сообщениями, а затем прекращают свою работу. Первый <strong>actor</strong> посылает &#8220;Ping&#8221; сообщения второму <strong>actor</strong>&#8217;у, который, в свою очередь, посылает &#8220;Pong&#8221; сообщения обратно (на каждый полученный &#8220;Ping&#8221; один &#8220;Pong&#8221;).<br />
В начале мы определяем сообщения, которые и будут курсировать между нашими <strong>actor</strong>&#8217;ов. Для этого мы используем Singleton объекты (в более сложных программах, сообщения, как правило, параметризованы). Поскольку мы хотим использовать <strong>pattern matching</strong> (который мы рассмотрим в следующий раз), каждое сообщение, является <strong>case object</strong>:</p>
<div class="highlight"><pre><code class="scala"><span class="k">case</span> <span class="k">object</span> <span class="nc">Ping</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">Pong</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">Stop</span>
</code></pre>
</div><p>Далее определяются классы <strong>Ping</strong> и <strong>Pong</strong>, которые наследуют <strong>trait Actor</strong> и реализуют метод <strong>act</strong>:</p>
<div class="highlight"><pre><code class="scala"><span class="k">class</span> <span class="nc">Ping</span><span class="o">(</span><span class="n">count</span><span class="k">:</span> <span class="kt">int</span><span class="o">,</span> <span class="n">pong</span><span class="k">:</span> <span class="kt">Actor</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">act</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">var</span> <span class="n">pingsLeft</span> <span class="k">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">pong</span> <span class="o">!</span> <span class="nc">Ping</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">receive</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Pong</span> <span class="k">=&gt;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">pingsLeft</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
            <span class="nc">Console</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="s">&quot;Ping: pong&quot;</span><span class="o">)</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">pingsLeft</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">pong</span> <span class="o">!</span> <span class="nc">Ping</span>
            <span class="n">pingsLeft</span> <span class="o">-=</span> <span class="mi">1</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">Console</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="s">&quot;Ping: stop&quot;</span><span class="o">)</span>
            <span class="n">pong</span> <span class="o">!</span> <span class="nc">Stop</span>
            <span class="n">exit</span><span class="o">()</span>
          <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div><p><br/></p>
<div class="highlight"><pre><code class="scala"><span class="k">class</span> <span class="nc">Pong</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">act</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">var</span> <span class="n">pongCount</span> <span class="k">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">receive</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Ping</span> <span class="k">=&gt;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">pongCount</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
            <span class="nc">Console</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="s">&quot;Pong: ping &quot;</span><span class="o">+</span><span class="n">pongCount</span><span class="o">)</span>
          <span class="n">sender</span> <span class="o">!</span> <span class="nc">Pong</span>
          <span class="n">pongCount</span> <span class="k">=</span> <span class="n">pongCount</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">case</span> <span class="nc">Stop</span> <span class="k">=&gt;</span>
          <span class="nc">Console</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="s">&quot;Pong: stop&quot;</span><span class="o">)</span>
          <span class="n">exit</span><span class="o">()</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div><p>Количество <strong>Ping</strong> сообщений, которые будут отправлены <strong>Pong</strong> актеру и сам <strong>Pong</strong> актор передаются в качестве аргумента в конструктор класса <strong>Ping</strong>. <strong>receive</strong> метод находясь внутри бесконечного цикла приостанавливает актор, пока сообщение <strong>Pong</strong> не дойдет до актера. Когда сообщение будет доставлено, оно исчезнет из <strong>mailbox</strong>&#8216;a актера и будет обработано определенным образом. В случае, когда <strong>pingsLeft</strong> больше нуля, мы посылаем <strong>Ping</strong> сообщение для <strong>Pong</strong>&#8217;a с помощью оператора отправить <strong>!</strong> и уменьшает <strong>pingsLeft</strong> на еденицу. Если <strong>pingsLeft</strong> достиг нуля, мы посылаем сообщение <strong>Stop Pong</strong>&#8217;у, и прекращаем выполнение текущего актера, вызывая <strong>exit()</strong>.</p>
<p>Актеры всегда выполняются на пуле потоков. Первоначально в пуле 4 рабочих потока. Пул возрастает, если все рабочие потоки заблокированы, но в нем все еще остаются задачи, которые нуждаются в обработке. В идеале, размер пула соответствует количеству ядер процессора.</p>
<p>Когда <strong>actor</strong> входит в выполнение метода <strong>receive</strong> (либо другой  блокирующий метод), рабочий поток блокируется. Это означает, что в основе <strong>actor</strong>&#8217;a лежит блокирующая операция, эту ситуацию можно избежать.<br />
Потоко блокирующие операции можно избежать, используя <strong>react</strong> метод, который ждет новых сообщений (на основе <strong>event-based</strong> реализации метода <strong>receive</strong>). Однако, есть (обычно малая) вероятность, что <strong>react</strong> никогда не вернет значение(не получит нового сообщения). На практике это означает, что на конец реакция на сообщение, нужно позвонить некоторой функции, которая содержит остальные вычисления актера. Заметим, что <strong>react</strong> внутри while  цикла не работает! Однако, существует специальная реализация цикла: <strong>loop</strong>. Она может быть использована следующим образом:</p>
<div class="highlight"><pre><code class="scala"><span class="k">def</span> <span class="n">act</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">pongCount</span> <span class="k">=</span> <span class="mi">0</span>
  <span class="n">loop</span> <span class="o">{</span>
    <span class="n">react</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Ping</span> <span class="k">=&gt;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pongCount</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
          <span class="nc">Console</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="s">&quot;Pong: ping &quot;</span><span class="o">+</span><span class="n">pongCount</span><span class="o">)</span>
        <span class="n">sender</span> <span class="o">!</span> <span class="nc">Pong</span>
        <span class="n">pongCount</span> <span class="k">=</span> <span class="n">pongCount</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">case</span> <span class="nc">Stop</span> <span class="k">=&gt;</span>
        <span class="nc">Console</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="s">&quot;Pong: stop&quot;</span><span class="o">)</span>
        <span class="n">exit</span><span class="o">()</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div><h4>Другие реализации</h4>
<p>Кроме стандартной реализации существуют и другие реализации <strong>Actor</strong>&#8216;ов, одна из интереснейших это <a href="http://wiki.github.com/jboner/akka/reference-actors-scala-api">Akka</a>, которая очень бурно развивается её автором <a href="http://jonasboner.com/">Jonas Bonér</a>&#8217;ом.</p>
<p><strong>Akka</strong> призвана стать своего рода <strong>framework</strong>&#8216;ом, который поддерживает <strong>System Of Service</strong> приложения. Она имеет много возможностей, слишком много, чтобы охватить все сразу и поэтому я хочу рассмотреть только возможности <strong>Акка&#8217;s Actors Supervisor</strong>. <br />
В <strong>Akka</strong> реализованна <strong>Actor</strong> модель с <strong>supervision</strong> деревьями, основанная на принципах <strong><span class="caps">OTP</span></strong> дизайна Эрланга. <strong>Supervision</strong> являются процессами, которые контролируют набор рабочих акторов выполняющих какие либо задачи (какую либо обработку данных). Основной идеей является то, что <strong>Supervision</strong> должен держать свои дочерние процессы под контролем, перезапуская их при необходимости. Когда <strong>actor</strong> умирает ненормально (бросая исключение), сигнал доходит до <strong>Supervision</strong>&#8216;ера, чтобы определить, что делать с ним. Он может принять решение о перезагрузке <strong>actor</strong>&#8217;а и пытается обработать сообщение снова. Этот подход ожидает, что неудачи могут быть и в конечном итоге произойдут. Вместо того, чтобы предотвратить неудачу, данных подход допускает это падение (<a href="http://letitcrash.com/">Let it crash</a> &#8211; TM Jonas Bonér), либо сбрасывает работника в стабильное состояние, либо перезапускает его. Эта идея также послужила в Ericsson при создании высокой отказоустойчивости для распределенной передачи сообщений. Для более подробного обзора надо писать отдельную статью, по этому остановимся на этой информации :)</p>

	
		<h4>Posted 13 Dec 2009 by Anton Panasenko | tags:
		 
			
				<a href="/search/label/fl">fl</a>,
			 
		 
			
				<a href="/search/label/fp">fp</a>,
			 
		 
			
				<a href="/search/label/jvm">jvm</a>,
			 
		 
					
				<a href="/search/label/scala">scala</a>
			 
		 
			
				and <a href="/search/label/actors">actors</a>.
			 
		
	</h4>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = 'http://dieu.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript">
	$('#main').removeClass('selected');
	$('#post').addClass('selected');
</script>

<!--

-->

	</div>
</div>
<!-- <div id="footer">
	<a href="">Source code</a>
</div> -->

 <script type="text/javascript">
var disqus_shortname = 'dieu';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.src = 'http://disqus.com/forums/dieu/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
 </script>

  
<!-- Yandex.Metrika counter -->
<div style="display:none;"><script type="text/javascript">
(function(w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter445478 = new Ya.Metrika(445478);
             yaCounter445478.clickmap(true);
             yaCounter445478.trackLinks(true);
        
        } catch(e) { }
    });
})(window, 'yandex_metrika_callbacks');
</script></div>
<script src="//mc.yandex.ru/metrika/watch.js" type="text/javascript" defer="defer"></script>
<noscript><img src="//mc.yandex.ru/watch/445478" style="position:absolute; left:-9999px;" alt="" /></noscript>
<!-- /Yandex.Metrika counter -->

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6891853-5']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>