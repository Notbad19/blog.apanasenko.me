<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru">
	<head>
 	  	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	  	<title>
	    	 Hg server install  
	  	</title>
		<link rel="stylesheet" href="/css/style.css" type="text/css" media="all"/>
	</head>
<body>
<div id="header">
	<ul id="nav" class="nav"> 
		<li id="main" class="selected"><a href="/"><strong>Home</strong><span>main page</span></a></li> 
		<li id="post"><a href="/2009/11/hg-server-install"><strong>Blog</strong> <span>post</span></a></li>
		<li id="archive"><a href="/archive"><strong>Archive</strong></a></li> 
		<li><a href="http://ru.linkedin.com/in/apanasenko/"><strong>LinkedIn</strong> <span>&rarr;</span></a></li> 
		<li><a href="http://github.com/dieu"><strong>Github</strong> <span>&rarr;</span></a></li> 
		<li><a href="http://twitter.com/apanasenko"><strong>Twitter</strong> <span>&rarr;</span></a></li> 
	</ul>
</div>
<div id="container">			
	<div class="bar"> 
	</div> 
	<br/>
	<div id="content">
			<!-- <span id="article_buttons">
  <a id="tweet">
    <span class="balloon">tweet!</span> <img src="/images/tweet.png"/ alt="tweet"/>
  </a>
  <a href="http://feeds.feedburner.com/apanasenko">
    <span class="balloon">subscribe!</span> <img src="/images/feed.png" alt="feed"/> 
  </a>
</span>

<hr/> -->

<div class="content">
	<center><img src="http://lh6.ggpht.com/_wN3Yn5K_LYs/Sv9RZPG2API/AAAAAAAAACs/I0Qq9icgvCA/Mercurial_logo.png?imgmax=800" alt="Mercurial_logo.png" width="200" height="240" /></center>
<p>Опять ударила пуля в голову и захотелось на домашнем сервере держать <strong>Mercurial</strong> репозиторий, который был бы доступен по http. Для этого нам понадобится <strong>Mercurial</strong>, <strong>Python</strong>, <strong>Apache2</strong>, все производиться на Ubuntu, но и для других OS принцип будет тот же.</p>
<div class="highlight"><pre><code class="bash">sudo su -
apt-get install mercurial apache2 libapache2-mod-python
a2enmod python
/etc/init.d/apache2 reload
mkdir /home/hg
chown www-data:www-data /home/hg
<span class="nb">cd</span> /home/hg
</code></pre>
</div><p>Потом создаем файл <strong>modpython_gateway.py</strong> с содержанием:</p>
<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">from</span> <span class="nn">mod_python</span> <span class="kn">import</span> <span class="n">apache</span>


<span class="k">class</span> <span class="nc">InputWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
<span class="bp">self</span><span class="o">.</span><span class="n">req</span> <span class="o">=</span> <span class="n">req</span>

<span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="k">pass</span>

<span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hint</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
<span class="k">while</span> <span class="n">line</span><span class="p">:</span>
<span class="k">yield</span> <span class="n">line</span>
<span class="c"># Notice this won&#39;t prefetch the next line; it only</span>
<span class="c"># gets called if the generator is resumed.</span>
<span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ErrorWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
<span class="bp">self</span><span class="o">.</span><span class="n">req</span> <span class="o">=</span> <span class="n">req</span>

<span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="k">pass</span>

<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">writelines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">):</span>
<span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">seq</span><span class="p">))</span>


<span class="n">bad_value</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;You must provide a PythonOption &#39;</span><span class="si">%s</span><span class="s">&#39;, either &#39;on&#39; or &#39;off&#39;, &quot;</span>
<span class="s">&quot;when running a version of mod_python &lt; 3.1&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Handler</span><span class="p">:</span>

<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
<span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">options</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span>

<span class="c"># Threading and forking</span>
<span class="k">try</span><span class="p">:</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">apache</span><span class="o">.</span><span class="n">mpm_query</span>
<span class="n">threaded</span> <span class="o">=</span> <span class="n">q</span><span class="p">(</span><span class="n">apache</span><span class="o">.</span><span class="n">AP_MPMQ_IS_THREADED</span><span class="p">)</span>
<span class="n">forked</span> <span class="o">=</span> <span class="n">q</span><span class="p">(</span><span class="n">apache</span><span class="o">.</span><span class="n">AP_MPMQ_IS_FORKED</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
<span class="n">threaded</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;multithread&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="k">if</span> <span class="n">threaded</span> <span class="o">==</span> <span class="s">&#39;on&#39;</span><span class="p">:</span>
<span class="n">threaded</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">elif</span> <span class="n">threaded</span> <span class="o">==</span> <span class="s">&#39;off&#39;</span><span class="p">:</span>
<span class="n">threaded</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">else</span><span class="p">:</span>
<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">bad_value</span> <span class="o">%</span> <span class="s">&quot;multithread&quot;</span><span class="p">)</span>

<span class="n">forked</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;multiprocess&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="k">if</span> <span class="n">forked</span> <span class="o">==</span> <span class="s">&#39;on&#39;</span><span class="p">:</span>
<span class="n">forked</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">elif</span> <span class="n">forked</span> <span class="o">==</span> <span class="s">&#39;off&#39;</span><span class="p">:</span>
<span class="n">forked</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">else</span><span class="p">:</span>
<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">bad_value</span> <span class="o">%</span> <span class="s">&quot;multiprocess&quot;</span><span class="p">)</span>

<span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">apache</span><span class="o">.</span><span class="n">build_cgi_env</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>

<span class="k">if</span> <span class="s">&#39;SCRIPT_NAME&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
<span class="c"># Override SCRIPT_NAME and PATH_INFO if requested.</span>
<span class="n">env</span><span class="p">[</span><span class="s">&#39;SCRIPT_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;SCRIPT_NAME&#39;</span><span class="p">]</span>
<span class="n">env</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">uri</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;SCRIPT_NAME&#39;</span><span class="p">]):]</span>

<span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InputWrapper</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ErrorWrapper</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.run_once&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;HTTPS&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;yes&#39;</span><span class="p">,</span> <span class="s">&#39;on&#39;</span><span class="p">,</span> <span class="s">&#39;1&#39;</span><span class="p">):</span>
<span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.url_scheme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;https&#39;</span>
<span class="k">else</span><span class="p">:</span>
<span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.url_scheme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;http&#39;</span>
<span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.multithread&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">threaded</span>
<span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.multiprocess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forked</span>

<span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">req</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">):</span>
<span class="k">try</span><span class="p">:</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">application</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_response</span><span class="p">)</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
<span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">set_content_length</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">):</span>
<span class="n">result</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
<span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.errors&#39;</span><span class="p">])</span>
<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
<span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">500</span>
<span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;text/plain&#39;</span>
<span class="n">data</span> <span class="o">=</span> <span class="s">&quot;A server error occurred. Please contact the administrator.&quot;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">set_content_length</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">start_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="k">if</span> <span class="n">exc_info</span><span class="p">:</span>
<span class="k">try</span><span class="p">:</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
<span class="k">raise</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="k">finally</span><span class="p">:</span>
<span class="n">exc_info</span> <span class="o">=</span> <span class="bp">None</span>

<span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">status</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>

<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
<span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;content-length&#39;</span><span class="p">:</span>
<span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">set_content_length</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
<span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;content-type&#39;</span><span class="p">:</span>
<span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="n">val</span>
<span class="k">else</span><span class="p">:</span>
<span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers_out</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>

<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
<span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="bp">True</span>
<span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="n">startup</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">cleanup</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
<span class="c"># Run a startup function if requested.</span>
<span class="k">global</span> <span class="n">startup</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">startup</span><span class="p">:</span>
<span class="n">func</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;wsgi.startup&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">func</span><span class="p">:</span>
<span class="n">module_name</span><span class="p">,</span> <span class="n">object_str</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;::&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">])</span>
<span class="n">startup</span> <span class="o">=</span> <span class="n">apache</span><span class="o">.</span><span class="n">resolve_object</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">object_str</span><span class="p">)</span>
<span class="n">startup</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

<span class="c"># Register a cleanup function if requested.</span>
<span class="k">global</span> <span class="n">cleanup</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">cleanup</span><span class="p">:</span>
<span class="n">func</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;wsgi.cleanup&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">func</span><span class="p">:</span>
<span class="n">module_name</span><span class="p">,</span> <span class="n">object_str</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;::&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">])</span>
<span class="n">cleanup</span> <span class="o">=</span> <span class="n">apache</span><span class="o">.</span><span class="n">resolve_object</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">object_str</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cleaner</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="n">cleanup</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
<span class="c"># apache.register_cleanup wasn&#39;t available until 3.1.4.</span>
<span class="n">apache</span><span class="o">.</span><span class="n">register_cleanup</span><span class="p">(</span><span class="n">cleaner</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
<span class="n">req</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">register_cleanup</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">cleaner</span><span class="p">)</span>

<span class="c"># Import the wsgi &#39;application&#39; callable and pass it to Handler.run</span>
<span class="n">modname</span><span class="p">,</span> <span class="n">objname</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_options</span><span class="p">()[</span><span class="s">&#39;wsgi.application&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;::&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">])</span>
<span class="n">app</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">objname</span><span class="p">)</span>
<span class="n">Handler</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="c"># status was set in Handler; always return apache.OK</span>
<span class="k">return</span> <span class="n">apache</span><span class="o">.</span><span class="n">OK</span>
</code></pre>
</div><p>или скачать <a href="http://www.aminus.net/browser/modpython_gateway.py?format=txt">отсюда</a>. Затем создаем тестовый репозиторий:</p>
<div class="highlight"><pre><code class="bash"><span class="nb">cd</span> /home/hg
mkdir hgtest; <span class="nb">cd </span>hgtest
hg init
<span class="nb">echo</span> <span class="s1">&#39;Hello World!&#39;</span> &gt;&gt; README.txt
hg add README.txt
hg commit -m <span class="s1">&#39;this is the first change to my test repository&#39;</span>
</code></pre>
</div><p>Затем создаем файл <strong>hgwebdir.py</strong> с содержанием:</p>
<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/env python</span>
<span class="c">#</span>
<span class="c"># $Id: hgwebdir.py 1478 2008-11-21 11:09:22Z matthew $</span>
<span class="c">#</span>
<span class="c"># An example CGI script to export multiple hgweb repos, edit as necessary</span>

<span class="c"># adjust python path if not a system-wide install:</span>
<span class="c">#import sys</span>
<span class="c">#sys.path.insert(0, &quot;/path/to/python/lib&quot;)</span>

<span class="c"># Uncomment to send python tracebacks to the browser if an error occurs:</span>
<span class="kn">import</span> <span class="nn">cgitb</span>
<span class="n">cgitb</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

<span class="c"># enable importing on demand to reduce startup time</span>
<span class="c"># from mercurial import demandimport; demandimport.enable()</span>
<span class="c"># from mercurial import demandload; demandload.enable()</span>

<span class="c"># If you&#39;d like to serve pages with UTF-8 instead of your default</span>
<span class="c"># locale charset, you can do so by uncommenting the following lines.</span>
<span class="c"># Note that this will cause your .hgrc files to be interpreted in</span>
<span class="c"># UTF-8 and all your repo files to be displayed using UTF-8.</span>
<span class="c">#</span>
<span class="c">#import os</span>
<span class="c">#os.environ[&quot;HGENCODING&quot;] = &quot;UTF-8&quot;</span>

<span class="kn">from</span> <span class="nn">mercurial.hgweb.hgweb_mod</span> <span class="kn">import</span> <span class="n">hgweb</span>
<span class="kn">from</span> <span class="nn">mercurial.hgweb.hgwebdir_mod</span> <span class="kn">import</span> <span class="n">hgwebdir</span>
<span class="kn">from</span> <span class="nn">mercurial.hgweb.request</span> <span class="kn">import</span> <span class="n">wsgiapplication</span>

<span class="c"># The config file looks like this.  You can have paths to individual</span>
<span class="c"># repos, collections of repos in a directory tree, or both.</span>
<span class="c">#</span>
<span class="c"># [paths]</span>
<span class="c"># virtual/path = /real/path</span>
<span class="c"># virtual/path = /real/path</span>
<span class="c">#</span>
<span class="c"># [collections]</span>
<span class="c"># /prefix/to/strip/off = /root/of/tree/full/of/repos</span>
<span class="c">#</span>
<span class="c"># collections example: say directory tree /foo contains repos /foo/bar,</span>
<span class="c"># /foo/quux/baz.  Give this config section:</span>
<span class="c">#   [collections]</span>
<span class="c">#   /foo = /foo</span>
<span class="c"># Then repos will list as bar and quux/baz.</span>
<span class="c">#</span>
<span class="c"># Alternatively you can pass a list of (&#39;virtual/path&#39;, &#39;/real/path&#39;) tuples</span>
<span class="c"># or use a dictionary with entries like &#39;virtual/path&#39;: &#39;/real/path&#39;</span>

<span class="c"># application = hgwebdir(&#39;hgweb.config&#39;)</span>
<span class="c"># wsgicgi.launch(application)</span>

<span class="k">def</span> <span class="nf">make_web_app</span><span class="p">():</span>
<span class="k">return</span> <span class="n">hgwebdir</span><span class="p">(</span><span class="s">&quot;/home/hg/hgweb.config&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gateway</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">wsgiapplication</span><span class="p">(</span><span class="n">make_web_app</span><span class="p">)</span>
<span class="k">return</span> <span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</code></pre>
</div><p>или качаем <a href="http://www.aventinesolutions.nl/code-samples/hgwebdir.py">отсюда</a>, но в нем надо изменить функцию:</p>
<div class="highlight"><pre><code class="python"><span class="k">def</span> <span class="nf">make_web_app</span><span class="p">():</span>
<span class="k">return</span> <span class="n">hgwebdir</span><span class="p">(</span><span class="s">&quot;/export/home/hg/hgweb.config&quot;</span><span class="p">)</span>
</code></pre>
</div><p>и заменить на правильный путь до файла <strong>hgweb.config</strong>, который состоит из:</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>collections<span class="o">]</span>
/home/hg <span class="o">=</span> /home/hg
</code></pre>
</div><p>в нем указываются пути до папки где хранятся репозитории. Далее настроим конфигурацию нашего тестового репозитория, она храниться в файле <strong>$REPO_PATH/.hg/hgrc</strong>:</p>
<div class="highlight"><pre><code class="bash"><span class="o">[</span>web<span class="o">]</span>
<span class="nv">contact</span> <span class="o">=</span> Anton Panasenko
<span class="nv">description</span> <span class="o">=</span> testing Mercurial Web
<span class="nv">style</span> <span class="o">=</span> coal
<span class="nv">allow_read</span> <span class="o">=</span> *
<span class="nv">allow_push</span> <span class="o">=</span> *
<span class="nv">push_ssl</span> <span class="o">=</span> <span class="nb">false</span>
<span class="nv">allow_archive</span> <span class="o">=</span> bz2 gz zip
</code></pre>
</div><p>поля <strong>allow_read = *</strong> и <strong>allow_push = *</strong> разграничивают доступ к репозиторию. В них можно указать имена пользователей, если вы будете использовать через Apache. Далее даем права Apache на папку и делаем скрипты исполняемыми:</p>
<div class="highlight"><pre><code class="bash"><span class="nb">cd</span> /home/
chown -R www-data:www-data hg/
chmod 755 hg/hgwebdir.py hg/modpython_gateway.py
</code></pre>
</div><p>В завершении нам осталось только сконфигурировать Apache, а именно создать файл hg.conf:</p>
<div class="highlight"><pre><code class="bash">&lt;Location /hg&gt;
PythonPath <span class="s2">&quot;sys.path + [ &#39;/home/hg&#39; ]&quot;</span>
PythonDebug On
SetHandler mod_python
PythonHandler modpython_gateway::handler
PythonOption SCRIPT_NAME /hg
PythonOption wsgi.application hgwebdir::gateway
AuthType Basic
AuthName <span class="s2">&quot;Aventine Solutions&quot;</span>
AuthUserFile conf/httpd.passwd
&amp;lt LimitExcept GET&gt;
require user matthew
&lt;/LimitExcept&gt;
&lt;/Location&gt;
</code></pre>
</div><p>затем подключим этот файл в главный конфиг Apache <strong>/etc/apache2/apache2.conf</strong> добавив строчку:</p>
<div class="highlight"><pre><code class="bash">Include /etc/apache2/hg.conf
</code></pre>
</div><p>или сохранить его в папке <strong>/etc/apache2/conf.d</strong>. Последняя команда:</p>
<div class="highlight"><pre><code class="bash">/etc/init.d/apache2 restart
</code></pre>
</div><p>и сервер готов к работе.</p>

	
		<h4>Posted 21 Nov 2009 by Anton Panasenko | tags:
		 
			
				<a href="/search/label/hg">hg</a>,
			 
		 
					
				<a href="/search/label/server">server</a>
			 
		 
			
				and <a href="/search/label/dvcs">dvcs</a>.
			 
		
	</h4>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = 'http://dieu.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript">
	$('#main').removeClass('selected');
	$('#post').addClass('selected');
</script>

<!--

-->

	</div>
</div>
<!-- <div id="footer">
	<a href="">Source code</a>
</div> -->

 <script type="text/javascript">
var disqus_shortname = 'dieu';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.src = 'http://disqus.com/forums/dieu/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
 </script>

  
<!-- Yandex.Metrika counter -->
<div style="display:none;"><script type="text/javascript">
(function(w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter445478 = new Ya.Metrika(445478);
             yaCounter445478.clickmap(true);
             yaCounter445478.trackLinks(true);
        
        } catch(e) { }
    });
})(window, 'yandex_metrika_callbacks');
</script></div>
<script src="//mc.yandex.ru/metrika/watch.js" type="text/javascript" defer="defer"></script>
<noscript><img src="//mc.yandex.ru/watch/445478" style="position:absolute; left:-9999px;" alt="" /></noscript>
<!-- /Yandex.Metrika counter -->

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6891853-5']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>