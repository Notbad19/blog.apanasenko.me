<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru">
	<head>
 	  	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	  	<title>
	    	 Erlang (gen_server)  
	  	</title>
		<link rel="stylesheet" href="/css/style.css" type="text/css" media="all"/>
	</head>
<body>
<div id="header">
	<ul id="nav" class="nav"> 
		<li id="main" class="selected"><a href="/"><strong>Home</strong><span>main page</span></a></li> 
		<li id="post"><a href="/2009/10/erlang"><strong>Blog</strong> <span>post</span></a></li>
		<li id="archive"><a href="/archive"><strong>Archive</strong></a></li> 
		<li><a href="http://ru.linkedin.com/in/apanasenko/"><strong>LinkedIn</strong> <span>&rarr;</span></a></li> 
		<li><a href="http://github.com/dieu"><strong>Github</strong> <span>&rarr;</span></a></li> 
		<li><a href="http://twitter.com/apanasenko"><strong>Twitter</strong> <span>&rarr;</span></a></li> 
	</ul>
</div>
<div id="container">			
	<div class="bar"> 
	</div> 
	<br/>
	<div id="content">
			<!-- <span id="article_buttons">
  <a id="tweet">
    <span class="balloon">tweet!</span> <img src="/images/tweet.png"/ alt="tweet"/>
  </a>
  <a href="http://feeds.feedburner.com/apanasenko">
    <span class="balloon">subscribe!</span> <img src="/images/feed.png" alt="feed"/> 
  </a>
</span>

<hr/> -->

<div class="content">
	<p>Про Erlang достаточно много написано на русском (<a href="http://ru.wikipedia.org/wiki/Erlang">Вики</a>), по этому интереснее конкретные, простые примеры кода. А вот их днем с огнем не сыщешь, не в англоязычном интернете, не тем более в русском&#8230; Надо эту ситуацию, как то менять и начну пожалуй с себя :)</p>
<p>Сегодня я попробую показать простое использование gen_server&#8217;a, для имитации <a href="http://ru.wikipedia.org/wiki/MapReduce">MapReduce</a>.</p>
<div class="highlight"><pre><code class="erlang"><span class="p">-</span><span class="ni">module</span> <span class="p">(</span><span class="n">console</span><span class="p">,</span> <span class="p">[</span><span class="nv">Name</span><span class="p">]).</span>
<span class="p">-</span><span class="ni">behaviour</span> <span class="p">(</span><span class="n">gen_server</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_call</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">handle_cast</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">handle_info</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">code_change</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="nb">send</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">mapReduce</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">addWorker</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">result</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">getResult</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">history</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">start</span><span class="p">(</span><span class="nv">Args</span><span class="p">)</span> <span class="o">-&gt;</span>
 <span class="nn">gen_server</span><span class="p">:</span><span class="n">start_link</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">{</span><span class="no">?MODULE</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="nv">Args</span><span class="p">,</span> <span class="p">[]).</span> 

<span class="nf">init</span><span class="p">(</span><span class="nv">Args</span><span class="p">)</span> <span class="o">-&gt;</span>
 <span class="nn">lists</span><span class="p">:</span><span class="n">foreach</span><span class="p">(</span>
  <span class="k">fun</span><span class="p">(</span><span class="nv">Elem</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="nv">Elem</span><span class="p">:</span><span class="n">connect</span><span class="p">({</span><span class="no">?MODULE</span><span class="p">,</span> <span class="nv">Name</span><span class="p">})</span>
  <span class="k">end</span><span class="p">,</span>
  <span class="nv">Args</span><span class="p">),</span>
    <span class="nv">StateServer</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="n">reduce</span><span class="p">,</span> <span class="nn">dict</span><span class="p">:</span><span class="n">new</span><span class="p">(),</span>
     <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nn">dict</span><span class="p">:</span><span class="n">new</span><span class="p">(),</span> 
      <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="nv">Args</span><span class="p">,</span> 
       <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="p">[],</span> 
        <span class="nn">dict</span><span class="p">:</span><span class="n">new</span><span class="p">())))),</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">}.</span>
 
<span class="nb">send</span><span class="p">(</span><span class="nv">Msg</span><span class="p">)</span> <span class="o">-&gt;</span>
 <span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">{</span><span class="n">message</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">}).</span>
 
<span class="nf">mapReduce</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">Map</span><span class="p">,</span> <span class="nv">Args</span><span class="p">,</span> <span class="nv">Reduce</span><span class="p">)</span> <span class="o">-&gt;</span> 
 <span class="n">reduce</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">Reduce</span><span class="p">),</span>
 <span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">{</span><span class="n">message</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="nv">Id</span><span class="p">,</span> <span class="nv">Map</span><span class="p">,</span> <span class="nv">Args</span><span class="p">}).</span>
 
<span class="nf">reduce</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">)</span> <span class="o">-&gt;</span>
 <span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">{</span><span class="n">message</span><span class="p">,</span> <span class="n">reduce</span><span class="p">,</span> <span class="nv">Id</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">,</span> <span class="p">[]}).</span>
 
<span class="nf">addWorker</span><span class="p">(</span><span class="nv">Job</span><span class="p">)</span> <span class="o">-&gt;</span>
 <span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">{</span><span class="n">jobs</span><span class="p">,</span> <span class="nv">Job</span><span class="p">}).</span>
 
<span class="nf">result</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">Result</span><span class="p">)</span> <span class="o">-&gt;</span>
 <span class="nn">gen_server</span><span class="p">:</span><span class="n">cast</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">{</span><span class="n">result</span><span class="p">,</span> <span class="nv">Id</span><span class="p">,</span> <span class="nv">Result</span><span class="p">}).</span>
 
<span class="nf">history</span><span class="p">()</span> <span class="o">-&gt;</span>
 <span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">{</span><span class="n">history</span><span class="p">}).</span>
 
<span class="nf">getResult</span><span class="p">(</span><span class="nv">Id</span><span class="p">)</span> <span class="o">-&gt;</span>
 <span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">{</span><span class="n">history</span><span class="p">,</span> <span class="nv">Id</span><span class="p">}).</span> 

<span class="nf">handle_call</span><span class="p">({</span><span class="n">message</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">,</span> <span class="nv">Id</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">,</span> <span class="nv">Args</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">)</span> <span class="o">-&gt;</span>
 <span class="nv">ReturnMsg</span> <span class="o">=</span> <span class="k">case</span> <span class="nv">Msg</span> <span class="k">of</span>
  <span class="n">map</span> <span class="o">-&gt;</span>
   <span class="nv">NewState</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">),</span>
   <span class="nv">Jobs</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">fetch</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="nv">NewState</span><span class="p">),</span>
   <span class="nn">lists</span><span class="p">:</span><span class="n">foreach</span><span class="p">(</span>
     <span class="k">fun</span><span class="p">(</span><span class="nv">Elem</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="nv">Elem</span><span class="p">:</span><span class="n">run</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">,</span> <span class="nv">Args</span><span class="p">)</span>
     <span class="k">end</span><span class="p">,</span>
     <span class="nv">Jobs</span><span class="p">),</span>
   <span class="s">&quot;Run function&quot;</span><span class="p">;</span>   
  <span class="n">reduce</span> <span class="o">-&gt;</span> 
   <span class="nv">State</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">),</span>
   <span class="nv">Reduce</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">fetch</span><span class="p">(</span><span class="n">reduce</span><span class="p">,</span> <span class="nv">State</span><span class="p">),</span>
   <span class="nv">NewReduce</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">,</span> <span class="nv">Reduce</span><span class="p">),</span>
   <span class="nv">NewState</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="n">reduce</span><span class="p">,</span> <span class="nv">NewReduce</span><span class="p">,</span> <span class="nv">State</span><span class="p">),</span>
   <span class="s">&quot;Add reduce&quot;</span><span class="p">;</span>
  <span class="n">true</span> <span class="o">-&gt;</span>
   <span class="nv">NewState</span> <span class="o">=</span> <span class="nv">StateServer</span><span class="p">,</span>
   <span class="s">&quot;Faild msg&quot;</span>
 <span class="k">end</span><span class="p">,</span>
 <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">ReturnMsg</span><span class="p">,</span> <span class="nv">NewState</span><span class="p">};</span>
 
<span class="nf">handle_call</span><span class="p">({</span><span class="n">history</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">)</span> <span class="o">-&gt;</span> 
 <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nn">dict</span><span class="p">:</span><span class="n">fetch</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">),</span> <span class="nv">StateServer</span><span class="p">};</span>
<span class="nf">handle_call</span><span class="p">({</span><span class="n">history</span><span class="p">,</span> <span class="nv">Id</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">)</span> <span class="o">-&gt;</span>
 <span class="nv">DictResult</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">fetch</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">),</span>
 <span class="nv">Result</span> <span class="o">=</span> 
  <span class="k">case</span> <span class="nn">dict</span><span class="p">:</span><span class="n">is_key</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">DictResult</span><span class="p">)</span> <span class="k">of</span>
   <span class="n">true</span> <span class="o">-&gt;</span>
    <span class="nn">dict</span><span class="p">:</span><span class="n">fetch</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">DictResult</span><span class="p">);</span>
   <span class="n">false</span> <span class="o">-&gt;</span>
    <span class="n">nil</span>
  <span class="k">end</span><span class="p">,</span>
 <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Result</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">};</span>
<span class="nf">handle_call</span><span class="p">({</span><span class="n">jobs</span><span class="p">,</span> <span class="nv">Job</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">)</span> <span class="o">-&gt;</span>
 <span class="nv">NewState</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">append</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="nv">Job</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">),</span>
 <span class="nv">Job</span><span class="p">:</span><span class="n">connect</span><span class="p">({</span><span class="no">?MODULE</span><span class="p">,</span> <span class="nv">Name</span><span class="p">}),</span>
 <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Job</span><span class="p">,</span> <span class="nv">NewState</span><span class="p">}.</span>

<span class="nf">handle_cast</span><span class="p">({</span><span class="n">result</span><span class="p">,</span> <span class="nv">Id</span><span class="p">,</span> <span class="nv">Result</span><span class="p">},</span> <span class="nv">StateServer</span><span class="p">)</span> <span class="o">-&gt;</span> 
 <span class="nv">DictResult</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">fetch</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">),</span>
 <span class="nv">NewState</span> <span class="o">=</span> <span class="k">case</span> <span class="nn">dict</span><span class="p">:</span><span class="n">is_key</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">DictResult</span><span class="p">)</span> <span class="k">of</span>
  <span class="n">true</span> <span class="o">-&gt;</span>
   <span class="nv">Jobs</span> <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="nn">dict</span><span class="p">:</span><span class="n">fetch</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">)),</span>
   <span class="nv">NewResult</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">append</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">Result</span><span class="p">,</span> <span class="nv">DictResult</span><span class="p">),</span>
   <span class="nv">State</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nv">NewResult</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">),</span>
   <span class="nv">ResultId</span> <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="nn">dict</span><span class="p">:</span><span class="n">fetch</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">NewResult</span><span class="p">)),</span>
   <span class="nv">Results</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">fetch</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">NewResult</span><span class="p">),</span>
   <span class="k">case</span> <span class="p">(</span><span class="nv">Jobs</span> <span class="o">==</span> <span class="nv">ResultId</span><span class="p">)</span> <span class="k">of</span>
    <span class="n">true</span> <span class="o">-&gt;</span>
     <span class="nv">Reduce</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">fetch</span><span class="p">(</span><span class="n">reduce</span><span class="p">,</span> <span class="nv">State</span><span class="p">),</span>
     <span class="k">case</span> <span class="nn">dict</span><span class="p">:</span><span class="n">is_key</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">Reduce</span><span class="p">)</span> <span class="k">of</span>
      <span class="n">true</span> <span class="o">-&gt;</span>
       <span class="nv">Fun</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">fetch</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">Reduce</span><span class="p">),</span>
       <span class="nv">EndResult</span> <span class="o">=</span> <span class="nv">Fun</span><span class="p">(</span><span class="nv">Results</span><span class="p">),</span>
       <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">EndResult</span><span class="p">,</span> <span class="nv">NewResult</span><span class="p">),</span> <span class="nv">State</span><span class="p">);</span>       
      <span class="n">false</span> <span class="o">-&gt;</span>
       <span class="nv">EndResult</span> <span class="o">=</span> <span class="s">&quot;Faild&quot;</span><span class="p">,</span>
       <span class="nn">io</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;sddd</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">),</span>
       <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">EndResult</span><span class="p">,</span> <span class="nv">NewResult</span><span class="p">),</span> <span class="nv">State</span><span class="p">)</span>
     <span class="k">end</span><span class="p">;</span>
    <span class="n">false</span> <span class="o">-&gt;</span>
     <span class="nv">State</span>
   <span class="k">end</span><span class="p">;</span>
  <span class="n">false</span> <span class="o">-&gt;</span>
   <span class="nv">NewResult</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="p">[</span><span class="nv">Result</span><span class="p">],</span> <span class="nv">DictResult</span><span class="p">),</span>
   <span class="nv">State</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nv">NewResult</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">)</span>
 <span class="k">end</span><span class="p">,</span>
 <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">NewState</span><span class="p">}.</span>
 
<span class="nf">handle_info</span><span class="p">(_</span><span class="nv">Message</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">)</span> <span class="o">-&gt;</span> 
 <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">}.</span>
<span class="nf">terminate</span><span class="p">(_</span><span class="nv">Reason</span><span class="p">,</span> <span class="p">_</span><span class="nv">StateServer</span><span class="p">)</span> <span class="o">-&gt;</span> 
 <span class="n">ok</span><span class="p">.</span>
<span class="nf">code_change</span><span class="p">(_</span><span class="nv">OldVersion</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">,</span> <span class="p">_</span><span class="nv">Extra</span><span class="p">)</span> <span class="o">-&gt;</span> 
 <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">}.</span>
</code></pre>
</div><p>В этом листинге используется gen_server для обработки сообщений/команд и управления &#8220;кластером&#8221;.</p>
<div class="highlight"><pre><code class="erlang"><span class="p">-</span><span class="ni">module</span> <span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="p">[</span><span class="nv">Name</span><span class="p">]).</span>
<span class="p">-</span><span class="ni">behaviour</span> <span class="p">(</span><span class="n">gen_server</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_call</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">handle_cast</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">handle_info</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">code_change</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
<span class="p">-</span><span class="ni">export</span> <span class="p">([</span><span class="n">run</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">connect</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">history</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span> 
 <span class="nn">gen_server</span><span class="p">:</span><span class="n">start_link</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">{</span><span class="no">?MODULE</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">[],</span> <span class="p">[]).</span>
 
<span class="nf">init</span><span class="p">([])</span> <span class="o">-&gt;</span>
    <span class="nv">StateServer</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="nb">node</span><span class="p">,</span> <span class="p">[],</span> 
     <span class="nn">dict</span><span class="p">:</span><span class="n">new</span><span class="p">()),</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">}.</span>

<span class="nf">run</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">,</span> <span class="nv">Args</span><span class="p">)</span> <span class="o">-&gt;</span> 
 <span class="nn">gen_server</span><span class="p">:</span><span class="n">cast</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">{</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">,</span> <span class="nv">Args</span><span class="p">}).</span>

<span class="nf">connect</span><span class="p">(</span><span class="nv">Node</span><span class="p">)</span> <span class="o">-&gt;</span>
 <span class="nn">gen_server</span><span class="p">:</span><span class="n">cast</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">{</span><span class="nb">node</span><span class="p">,</span> <span class="nv">Node</span><span class="p">}).</span>

<span class="nf">history</span><span class="p">(</span><span class="nv">Id</span><span class="p">)</span> <span class="o">-&gt;</span> 
 <span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">({</span><span class="n">global</span><span class="p">,</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">{</span><span class="n">history</span><span class="p">,</span> <span class="nv">Id</span><span class="p">}).</span>

<span class="nf">handle_call</span><span class="p">({</span><span class="n">history</span><span class="p">,</span> <span class="nv">Id</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">)</span> <span class="o">-&gt;</span>
 <span class="nv">Reply</span> <span class="o">=</span> <span class="k">case</span> <span class="nn">dict</span><span class="p">:</span><span class="n">is_key</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">)</span> <span class="k">of</span>
  <span class="n">true</span> <span class="o">-&gt;</span> 
   <span class="nn">dict</span><span class="p">:</span><span class="n">fetch</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">);</span>
  <span class="n">false</span> <span class="o">-&gt;</span>
   <span class="n">nil</span>
  <span class="k">end</span><span class="p">,</span> 
 <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">}.</span>
 
<span class="nf">handle_cast</span><span class="p">({</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">,</span> <span class="nv">Args</span><span class="p">},</span> <span class="nv">StateServer</span><span class="p">)</span> <span class="o">-&gt;</span> 
 <span class="nv">Reply</span> <span class="o">=</span> <span class="nv">Fun</span><span class="p">(</span><span class="nv">Args</span><span class="p">),</span>
 <span class="nv">NewState</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">),</span>
 <span class="nv">Node</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">fetch</span><span class="p">(</span><span class="nb">node</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">),</span>
 <span class="nn">lists</span><span class="p">:</span><span class="n">foreach</span><span class="p">(</span>
  <span class="k">fun</span><span class="p">(</span><span class="nv">Elem</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">Elem</span><span class="p">:</span><span class="n">result</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">)</span>
  <span class="k">end</span><span class="p">,</span>
  <span class="nv">Node</span><span class="p">),</span>
 <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">NewState</span><span class="p">};</span>
<span class="nf">handle_cast</span><span class="p">({</span><span class="nb">node</span><span class="p">,</span> <span class="nv">Node</span><span class="p">},</span> <span class="nv">StateServer</span><span class="p">)</span> <span class="o">-&gt;</span>
 <span class="nv">NewState</span> <span class="o">=</span> <span class="nn">dict</span><span class="p">:</span><span class="n">append</span><span class="p">(</span><span class="nb">node</span><span class="p">,</span> <span class="nv">Node</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">),</span>
 <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">NewState</span><span class="p">}.</span>
 
<span class="nf">handle_info</span><span class="p">(_</span><span class="nv">Message</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">)</span> <span class="o">-&gt;</span> 
 <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">}.</span>
<span class="nf">terminate</span><span class="p">(_</span><span class="nv">Reason</span><span class="p">,</span> <span class="p">_</span><span class="nv">StateServer</span><span class="p">)</span> <span class="o">-&gt;</span> 
 <span class="n">ok</span><span class="p">.</span>
<span class="nf">code_change</span><span class="p">(_</span><span class="nv">OldVersion</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">,</span> <span class="p">_</span><span class="nv">Extra</span><span class="p">)</span> <span class="o">-&gt;</span> 
 <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">StateServer</span><span class="p">}.</span>
</code></pre>
</div><p>А в этом уже и происходит исполнение какой-то функции и возврат результата по запросу от управляющего процесса.</p>
<p>В видео видно как этот код собирается в &#8220;кластер&#8221; и запускается на простое задание.</p>
<p><object height="344" width="640"><param name="movie" value="http://www.youtube.com/v/fHIPNQItTvg&hl=en&fs=1"><br />
</param><br />
<param name="allowFullScreen" value="true"><br />
</param><br />
<param name="allowscriptaccess" value="always"><br />
</param><br />
<embed src="http://www.youtube.com/v/fHIPNQItTvg&hl=en&fs=1" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="640" height="344"></embed></object></p>

	
		<h4>Posted 25 Oct 2009 by Anton Panasenko | tags:
		 
			
				<a href="/search/label/erlang">erlang</a>,
			 
		 
					
				<a href="/search/label/gen_server">gen_server</a>
			 
		 
			
				and <a href="/search/label/mapreduce">mapreduce</a>.
			 
		
	</h4>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = 'http://dieu.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript">
	$('#main').removeClass('selected');
	$('#post').addClass('selected');
</script>

<!--

-->

	</div>
</div>
<!-- <div id="footer">
	<a href="">Source code</a>
</div> -->

 <script type="text/javascript">
var disqus_shortname = 'dieu';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.src = 'http://disqus.com/forums/dieu/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
 </script>

  
<!-- Yandex.Metrika counter -->
<div style="display:none;"><script type="text/javascript">
(function(w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter445478 = new Ya.Metrika(445478);
             yaCounter445478.clickmap(true);
             yaCounter445478.trackLinks(true);
        
        } catch(e) { }
    });
})(window, 'yandex_metrika_callbacks');
</script></div>
<script src="//mc.yandex.ru/metrika/watch.js" type="text/javascript" defer="defer"></script>
<noscript><img src="//mc.yandex.ru/watch/445478" style="position:absolute; left:-9999px;" alt="" /></noscript>
<!-- /Yandex.Metrika counter -->

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6891853-5']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>