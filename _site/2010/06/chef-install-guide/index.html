<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru">
	<head>
 	  	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	  	<title>
	    	 Chef install guide  
	  	</title>
		<link rel="stylesheet" href="/css/style.css" type="text/css" media="all"/>
	</head>
<body>
<div id="header">
	<ul id="nav" class="nav"> 
		<li id="main" class="selected"><a href="/"><strong>Home</strong><span>main page</span></a></li> 
		<li id="post"><a href="/2010/06/chef-install-guide"><strong>Blog</strong> <span>post</span></a></li>
		<li id="archive"><a href="/archive"><strong>Archive</strong></a></li> 
		<li><a href="http://ru.linkedin.com/in/apanasenko/"><strong>LinkedIn</strong> <span>&rarr;</span></a></li> 
		<li><a href="http://github.com/dieu"><strong>Github</strong> <span>&rarr;</span></a></li> 
		<li><a href="http://twitter.com/apanasenko"><strong>Twitter</strong> <span>&rarr;</span></a></li> 
	</ul>
</div>
<div id="container">			
	<div class="bar"> 
	</div> 
	<br/>
	<div id="content">
			<!-- <span id="article_buttons">
  <a id="tweet">
    <span class="balloon">tweet!</span> <img src="/images/tweet.png"/ alt="tweet"/>
  </a>
  <a href="http://feeds.feedburner.com/apanasenko">
    <span class="balloon">subscribe!</span> <img src="/images/feed.png" alt="feed"/> 
  </a>
</span>

<hr/> -->

<div class="content">
	<center><a href="http://www.opscode.com/chef/"><img src="http://s3.amazonaws.com/opscode-corpsite/assets/53/legos_small_rounded_original_original.jpg" /></a></center>
<p><a href="http://www.opscode.com/chef/" title="Chef site"><strong>Chef</strong></a> это система провижининга приложений (достаточно удобная и гибкая система) со своими плюсами и недостатками. Но сегодня не много о другом, а именно об установке server-client варианта на EC2.</p>
<h3>Установка</h3>
<p>И так начнемс, для начала нам нужно поправить конфигурационные файлы системы:</p>
<div class="highlight"><pre><code class="bash">/etc/hosts
</code></pre>
</div><p>и указать нужный хостнейм и апи. Особенность амазона нужно указыать внутренний апи. У меня это выглядит так:</p>
<div class="highlight"><pre><code class="bash">127.0.0.1 localhost localhost.localdomain
10.240.107.36 ec2-174-129-85-251.compute-1.amazonaws.com ec2-174-129-85-251
</code></pre>
</div><p>Далее правим файл:</p>
<div class="highlight"><pre><code class="bash">/etc/sysconfig/network
</code></pre>
</div><p>выглядит так:</p>
<div class="highlight"><pre><code class="bash"><span class="nv">HOSTNAME</span><span class="o">=</span>ec2-174-129-85-251.compute-1.amazonaws.com
<span class="nv">NETWORKING</span><span class="o">=</span>yes
</code></pre>
</div><p>Затем добавляем репозитории для Fedora/RedHat/CentOS:</p>
<div class="highlight"><pre><code class="bash">rpm -Uvh http://download.fedora.redhat.com/pub/epel/5/i386/epel-release-5-3.noarch.rpm
rpm -Uvh http://download.elff.bravenet.com/5/i386/elff-release-5-3.noarch.rpm
</code></pre>
</div><p>После этого обновляем ruby до версии 1.8.6 и устанавливаем RubyGems:</p>
<div class="highlight"><pre><code class="bash"><span class="nb">cd</span> /tmp wget http://rubyforge.org/frs/download.php/69365/rubygems-1.3.6.tgz
tar zxf rubygems-1.3.6.tgz
<span class="nb">cd </span>rubygems-1.3.6
ruby setup.rb
</code></pre>
</div><p>Замечу что в принципе можно устанавливать и из репозитория. Затем добавляем репозиторий для RubyGems:</p>
<div class="highlight"><pre><code class="bash">gem sources -r http://gems.rubyforge.org/
gem sources -a http://rubygems.org/
</code></pre>
</div><p>И после этого начинаем установку Chef:</p>
<div class="highlight"><pre><code class="bash">gem install chef
</code></pre>
</div><h3>Конфигурация</h3>
<p>Далее нам надо установить и настроить либо Chef client либо Chef server. Начнем с server&#8217;а. Создаем файл chef.json меняя server_fqd на свой домен:</p>
<div class="highlight"><pre><code class="bash"><span class="nb">cd</span>
cat &gt; chef.json <span class="s">&lt;&lt; EOF</span>
<span class="s">{</span>
<span class="s">  &quot;bootstrap&quot;: {</span>
<span class="s">    &quot;chef&quot;: {</span>
<span class="s">      &quot;url_type&quot;: &quot;http&quot;,</span>
<span class="s">      &quot;init_style&quot;: &quot;init&quot;,</span>
<span class="s">      &quot;path&quot;: &quot;/srv/chef&quot;,</span>
<span class="s">      &quot;serve_path&quot;: &quot;/srv/chef&quot;,</span>
<span class="s">      &quot;server_fqdn&quot;: &quot;chef-server.example.com&quot;,</span>
<span class="s">      &quot;webui_enabled&quot;: true</span>
<span class="s">    }</span>
<span class="s">  },</span>
<span class="s">  &quot;run_list&quot;: [ &quot;recipe[bootstrap::server]&quot; ]</span>
<span class="s">}</span>
<span class="s">EOF</span>
</code></pre>
</div><p>Затем создаем файл solo.rb:</p>
<div class="highlight"><pre><code class="bash">cat &gt; solo.rb <span class="s">&lt;&lt; EOF</span>
<span class="s">file_cache_path &quot;/tmp/chef-solo&quot;</span>
<span class="s">cookbook_path &quot;/tmp/chef-solo/cookbooks&quot;</span>
<span class="s">recipe_url &quot;http://s3.amazonaws.com/chef-solo/bootstrap-latest.tar.gz&quot;</span>
<span class="s">EOF</span>
</code></pre>
</div><p>и запускаем установку сервера:</p>
<div class="highlight"><pre><code class="bash">chef-solo -c ~/solo.rb -j ~/chef.json
</code></pre>
</div><p>После этого создаем нужные папки и пользователя:</p>
<div class="highlight"><pre><code class="bash">useradd chef
chown chef:chef -R /srv/chef
chown chef:chef -R /var/log/chef
chown chef:chef -R /etc/chef
chown chef:chef -R /var/chef
cp /usr/lib64/ruby/gems/1.8/gems/chef-0.8.10/distro/redhat/etc/sysconfig/* /etc/sysconfig
cp /usr/lib64/ruby/gems/1.8/gems/chef-0.8.10/distro/redhat/etc/init.d/* /etc/init.d
chmod +x /etc/init.d/chef-*
<span class="k">for </span>svc in solr solr-indexer server server-webui
<span class="k">do</span>
<span class="k">  </span>sudo chmod +x /etc/init.d/chef-<span class="k">${</span><span class="nv">svc</span><span class="k">}</span>
  sudo chkconfig --add chef-<span class="k">${</span><span class="nv">svc</span><span class="k">}</span>
  sudo chkconfig chef-<span class="k">${</span><span class="nv">svc</span><span class="k">}</span> on
  sudo service chef-<span class="k">${</span><span class="nv">svc</span><span class="k">}</span> start
<span class="k">done</span>
</code></pre>
</div><p>Для клиента все тоже самое только различается chef.json:</p>
<div class="highlight"><pre><code class="bash"><span class="nb">cd</span>
cat &gt; chef.json <span class="s">&lt;&lt; EOF</span>
<span class="s">{</span>
<span class="s">  &quot;bootstrap&quot;: {</span>
<span class="s">    &quot;chef&quot;: {</span>
<span class="s">      &quot;url_type&quot;: &quot;http&quot;,</span>
<span class="s">      &quot;init_style&quot;: &quot;init&quot;,</span>
<span class="s">      &quot;path&quot;: &quot;/srv/chef&quot;,</span>
<span class="s">      &quot;serve_path&quot;: &quot;/srv/chef&quot;,</span>
<span class="s">      &quot;server_fqdn&quot;: &quot;chef.gemini.griddynamics.net&quot;</span>
<span class="s">    }</span>
<span class="s">  },</span>
<span class="s">  &quot;run_list&quot;: [ &quot;recipe[bootstrap::client]&quot; ]</span>
<span class="s">}</span>
<span class="s">EOF</span>
</code></pre>
</div><p>После чего клиент надо зарегистрировать на сервере, с помощью команды:</p>
<div class="highlight"><pre><code class="bash">scp chef-server:/etc/chef/validation.pem /etc/chef/
</code></pre>
</div><p>И можно запускать клиента:</p>
<div class="highlight"><pre><code class="bash">chef-client -V
</code></pre>
</div>

	
		<h4>Posted 10 Jun 2010 by Anton Panasenko | tags:
		 
			
				<a href="/search/label/chef">chef</a>,
			 
		 
					
				<a href="/search/label/deploy">deploy</a>
			 
		 
			
				and <a href="/search/label/ec2">ec2</a>.
			 
		
	</h4>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = 'http://dieu.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript">
	$('#main').removeClass('selected');
	$('#post').addClass('selected');
</script>

<!--

-->

	</div>
</div>
<!-- <div id="footer">
	<a href="">Source code</a>
</div> -->

 <script type="text/javascript">
var disqus_shortname = 'dieu';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.src = 'http://disqus.com/forums/dieu/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
 </script>

  
<!-- Yandex.Metrika counter -->
<div style="display:none;"><script type="text/javascript">
(function(w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter445478 = new Ya.Metrika(445478);
             yaCounter445478.clickmap(true);
             yaCounter445478.trackLinks(true);
        
        } catch(e) { }
    });
})(window, 'yandex_metrika_callbacks');
</script></div>
<script src="//mc.yandex.ru/metrika/watch.js" type="text/javascript" defer="defer"></script>
<noscript><img src="//mc.yandex.ru/watch/445478" style="position:absolute; left:-9999px;" alt="" /></noscript>
<!-- /Yandex.Metrika counter -->

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6891853-5']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>