---
layout: post
title: Chef install guide
excerpt: Chef - это система провижининга приложений (достаточно удобная и гибкая система) со своими плюсами и недостатками. Но сегодня не много о другом, а именно об установке server-client варианта на EC2.
published: true
categories:
- chef
- deploy
- ec2
---

<div class="separator" style="clear: both; text-align: center;"><a href="http://www.opscode.com/chef/" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://s3.amazonaws.com/opscode-corpsite/assets/53/legos_small_rounded_original_original.jpg" /></a></div>

"*Chef* (Chef site)":http://www.opscode.com/chef/ это система провижининга приложений (достаточно удобная и гибкая система) со своими плюсами и недостатками. Но сегодня не много о другом, а именно об установке server-client варианта на EC2.

h3. Установка

И так начнемс, для начала нам нужно поправить конфигурационные файлы системы:

{% highlight bash %}
/etc/hosts
{% endhighlight %}

и указать нужный хостнейм и апи. Особенность амазона нужно указыать внутренний апи. У меня это выглядит так:
    
{% highlight bash %}
127.0.0.1 localhost localhost.localdomain
10.240.107.36 ec2-174-129-85-251.compute-1.amazonaws.com ec2-174-129-85-251
{% endhighlight %}

Далее правим файл:

{% highlight bash %}
/etc/sysconfig/network
{% endhighlight %}

выглядит так:

{% highlight bash %}
HOSTNAME=ec2-174-129-85-251.compute-1.amazonaws.com
NETWORKING=yes
{% endhighlight %}

Затем добавляем репозитории для Fedora/RedHat/CentOS:

{% highlight bash %}
rpm -Uvh http://download.fedora.redhat.com/pub/epel/5/i386/epel-release-5-3.noarch.rpm
rpm -Uvh http://download.elff.bravenet.com/5/i386/elff-release-5-3.noarch.rpm
{% endhighlight %}

После этого обновляем ruby до версии 1.8.6 и устанавливаем RubyGems:

{% highlight bash %}
cd /tmp wget http://rubyforge.org/frs/download.php/69365/rubygems-1.3.6.tgz
tar zxf rubygems-1.3.6.tgz
cd rubygems-1.3.6
ruby setup.rb
{% endhighlight %}

Замечу что в принципе можно устанавливать и из репозитория. Затем добавляем репозиторий для RubyGems:

{% highlight bash %}
gem sources -r http://gems.rubyforge.org/
gem sources -a http://rubygems.org/
{% endhighlight %}

И после этого начинаем установку Chef:

{% highlight bash %}
gem install chef
{% endhighlight %}

h3. Конфигурация

Далее нам надо установить и настроить либо Chef client либо Chef server. Начнем с server'а. Создаем файл chef.json меняя server_fqd на свой домен:

{% highlight bash %}
cd
cat > chef.json << EOF
{
  "bootstrap": {
    "chef": {
      "url_type": "http",
      "init_style": "init",
      "path": "/srv/chef",
      "serve_path": "/srv/chef",
      "server_fqdn": "chef-server.example.com",
      "webui_enabled": true
    }
  },
  "run_list": [ "recipe[bootstrap::server]" ]
}
EOF
{% endhighlight %}

Затем создаем файл solo.rb:

{% highlight bash %}
cat > solo.rb << EOF
file_cache_path "/tmp/chef-solo"
cookbook_path "/tmp/chef-solo/cookbooks"
recipe_url "http://s3.amazonaws.com/chef-solo/bootstrap-latest.tar.gz"
EOF
{% endhighlight %}

и запускаем установку сервера:

{% highlight bash %}
chef-solo -c ~/solo.rb -j ~/chef.json
{% endhighlight %}

После этого создаем нужные папки и пользователя:

{% highlight bash %}
useradd chef
chown chef:chef -R /srv/chef
chown chef:chef -R /var/log/chef
chown chef:chef -R /etc/chef
chown chef:chef -R /var/chef
cp /usr/lib64/ruby/gems/1.8/gems/chef-0.8.10/distro/redhat/etc/sysconfig/* /etc/sysconfig
cp /usr/lib64/ruby/gems/1.8/gems/chef-0.8.10/distro/redhat/etc/init.d/* /etc/init.d
chmod +x /etc/init.d/chef-*
for svc in solr solr-indexer server server-webui
do
  sudo chmod +x /etc/init.d/chef-${svc}
  sudo chkconfig --add chef-${svc}
  sudo chkconfig chef-${svc} on
  sudo service chef-${svc} start
done
{% endhighlight %}

Для клиента все тоже самое только различается chef.json:

{% highlight bash %}
cd
cat > chef.json << EOF
{
  "bootstrap": {
    "chef": {
      "url_type": "http",
      "init_style": "init",
      "path": "/srv/chef",
      "serve_path": "/srv/chef",
      "server_fqdn": "chef.gemini.griddynamics.net"
    }
  },
  "run_list": [ "recipe[bootstrap::client]" ]
}
EOF
{% endhighlight %}

После чего клиент надо зарегистрировать на сервере, с помощью команды:

{% highlight bash %}
scp chef-server:/etc/chef/validation.pem /etc/chef/
{% endhighlight %}

И можно запускать клиента:

{% highlight bash %}
chef-client -V
{% endhighlight %}
